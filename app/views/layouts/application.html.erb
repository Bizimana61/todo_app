<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "TaskManager" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body>
    <!-- Skip link for keyboard users -->
    <a class="skip-link" href="#main-content">Skip to main content</a>

    <header class="site-header" role="banner">
      <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;">
        <div style="display:flex;align-items:center;gap:1rem;">
          <h1 class="app-title" style="margin:0;font-size:1.25rem;">
            <a href="<%= root_path %>" style="color:inherit;text-decoration:none;display:flex;align-items:center;gap:0.5rem;">
              <!-- TaskManager Logo SVG -->
              <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <!-- Gradient Definition -->
                <defs>
                  <linearGradient id="logo-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#2563eb;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#1e40af;stop-opacity:1" />
                  </linearGradient>
                </defs>
                <!-- Rounded Square Background -->
                <rect width="40" height="40" rx="10" fill="url(#logo-gradient)"/>
                <!-- Checkmark -->
                <path d="M28 13L17 24L12 19" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                <!-- List Lines -->
                <line x1="10" y1="10" x2="14" y2="10" stroke="white" stroke-width="2" stroke-linecap="round" opacity="0.7"/>
                <line x1="10" y1="30" x2="16" y2="30" stroke="white" stroke-width="2" stroke-linecap="round" opacity="0.7"/>
              </svg>
              <span>TaskManager</span>
            </a>
          </h1>

          <nav class="main-nav" role="navigation" aria-label="Primary" style="margin-left:1rem;">
            <ul style="list-style:none;margin:0;padding:0;display:flex;gap:.75rem;">
              <li><%= link_to 'Todos', todos_path %></li>
              <li><%= link_to 'New Todo', new_todo_path %></li>
            </ul>
          </nav>
        </div>

        <!-- User nav (login / signup / logout) -->
        <nav class="user-nav" aria-label="User" style="display:flex;align-items:center;gap:.75rem;">
          <% if logged_in? %>
            <%= link_to profile_path, class: 'user-avatar-link', title: 'My Profile', aria: { label: 'View profile' } do %>
              <% if current_user.avatar.present? %>
                <img src="<%= current_user.avatar %>" alt="<%= current_user.name || current_user.email %>" class="header-avatar">
              <% else %>
                <div class="header-avatar avatar-initials-small">
                  <%= current_user.initials %>
                </div>
              <% end %>
            <% end %>
            <span class="muted" style="margin-right:.5rem;"><%= current_user.name.presence || current_user.email %></span>
            <%= button_to 'Log out', logout_path, method: :delete, class: 'btn btn-sm', form: { data: { turbo: false } } %>
          <% else %>
            <%= link_to 'Log in', login_path, class: 'btn btn-secondary btn-sm', style: 'margin-right:.5rem;' %>
            <%= link_to 'Sign up', signup_path, class: 'btn btn-primary btn-sm' %>
          <% end %>
        </nav>
      </div>
    </header>

    <!-- Flash messages -->
    <div class="container" style="margin-top:.75rem;">
      <% flash.each do |name, message| %>
        <div class="flash <%= name %>" role="status" aria-live="polite" style="padding:.5rem .75rem;border-radius:6px;margin-bottom:.5rem;
            <%= 'background:#ecfdf5;color:#065f46;' if name.to_s == 'notice' %>
            <%= 'background:#fff1f2;color:#991b1b;' if name.to_s == 'alert' %>">
          <%= message %>
        </div>
      <% end %>
    </div>

    <main id="main-content" role="main" class="container" style="padding:1.5rem 1rem;">
      <%= yield %>
    </main>

    <footer role="contentinfo" class="site-footer" style="padding:1rem 0;text-align:center;color:#6b7280;border-top:1px solid #eef6ff;">
      <div class="container">&copy; <%= Time.now.year %> TaskManager built by Jerome Bizimana â€” Helping you stay organized.</div>
    </footer>
  </body>
</html>